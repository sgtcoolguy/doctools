<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Subscribing to push notifications</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta content="Scroll EclipseHelp Exporter" name="generator">

    <link type="text/css" rel="stylesheet" href="css/eclipse-defaults.css">
    <link type="text/css" rel="stylesheet" href="css/common.css">
    <link type="text/css" rel="stylesheet" href="css/print.css" media="print">
</head>
<body>
    <div class="container">
        <div class="header"></div>

        <div id="src-37551717" class="content">
                        <h1>Subscribing to push notifications</h1>
    <p>For a push notification to reach a user, the user (or device) must be subscribed to receive push notifications on one or more notification <i class=" ">channels</i>. The application must also obtain a <i class=" ">device token</i>, which permits Mobile Backend Services (MBS) to communicate with the push service provider (Google Cloud Messaging (GCM), Firebase Cloud Messaging (FCM), or Apple Push Notification). <a class="external-link external-link" href="http://firebase.google.com/docs/cloud-messaging/">Firebase Cloud Messaging</a> (FCM) is the new version of GCM. This guide explains how to how obtain a device token, and how to use the <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Modules.Cloud.PushNotifications">PushNotifications API</a> to manage your user&apos;s notification subscriptions.    </p>
    <p>    </p>
<ul class="toc-indentation "><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-Obtainingadevicetoken">Obtaining a device token</a>    </p>
<ul class="toc-indentation "><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-ObtainingadevicetokenonAndroid">Obtaining a device token on Android</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-ObtainingadevicetokenoniOS">Obtaining a device token on iOS</a>    </p>
</li></ul></li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-UsingtheTitaniumPushNotificationsAPI">Using the Titanium PushNotifications API</a>    </p>
<ul class="toc-indentation "><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-Session-andtoken-basedsubscriptions">Session- and token-based subscriptions</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-AddingtheCloudmoduletoyourproject">Adding the Cloud module to your project</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">Subscribing to Push Notifications with Device Tokens</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions">Subscribing to Push Notifications with User Sessions</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-UpdatingSubscriptionswithDeviceLocation">Updating Subscriptions with Device Location</a>    </p>
</li></ul></li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-Parsinganotificationpayload">Parsing a notification payload</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-Moreexamples">More examples</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-Troubleshooting">Troubleshooting</a>    </p>
<ul class="toc-indentation "><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_safe-id-U3Vic2NyaWJpbmd0b3B1c2hub3RpZmljYXRpb25zLVVuYWJsZXRvcmV0cmlldmVhZGV2aWNldG9rZW4oaU9TKQ">Unable to retrieve a device token (iOS)</a>    </p>
</li><li class=" ">    <p><a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_safe-id-U3Vic2NyaWJpbmd0b3B1c2hub3RpZmljYXRpb25zLUVycm9yOkFQU0Nsb3VkUHVzaGhhc25vdGJlZW5lbmFibGVkLkNhbGxBUFNDbG91ZC5lbmFibGUoY29udGV4dCxrZXkpdG9lbmFibGUuKEFuZHJvaWQp">Error: APSCloudPush has not been enabled. Call APSCloud.enable(context, key) to enable. (Android)</a>    </p>
</li></ul></li></ul>    <div class="section section-2 " id="src-37551717_Subscribingtopushnotifications-Obtainingadevicetoken">
        <h2 class="heading "><span>Obtaining a device token</span></h2>
    <p>To receive push notifications, your application first needs to obtain a <i class=" ">device token</i>. To obtain a device token:    </p>
<ul class=" "><li class=" ">    <p>On Android, call the <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Modules.CloudPush">CloudPush</a> module&apos;s<tt class=" "> retrieveDeviceToken()</tt>method    </p>
</li><li class=" ">    <p>On iOS, call the<tt class=" "> Titanium.Network.registerForPushNotifications()</tt>    </p>
</li></ul>    <p>Once your application has obtained a device token it should save it for later use.    </p>
    <div class="section section-3 " id="src-37551717_Subscribingtopushnotifications-ObtainingadevicetokenonAndroid">
        <h3 class="heading "><span>Obtaining a device token on Android</span></h3>
    <p>To obtain a device token from GCM or FCM, you first need to add the CloudPush module to your project. This module is included with the Titanium SDK, but is not included by default in new projects.    </p>
    <p><strong class=" ">To add the CloudPush module to your project</strong>:    </p>
<ol class=" "><li class=" ">    <p>In Studio, open your project&apos;s <tt class=" ">tiapp.xml</tt> file.    </p>
</li><li class=" ">    <p>In the <strong class=" ">Modules</strong> section, click the add (<strong class=" ">+</strong>) button.    </p>
</li><li class=" ">    <p>Select <strong class=" ">ti.cloudpush</strong> and click <strong class=" ">OK</strong>.    </p>
</li></ol>    <p>In your application code, require the <tt class=" ">ti.cloudpush</tt> module and call its <tt class=" ">retrieveDeviceToken()</tt> method, and register event handlers to respond to <tt class=" ">success</tt> and <tt class=" ">error</tt> events. Once a device token has been retrieved, your application can listen for the <tt class=" ">callback</tt> event to process incoming push notifications. Your application should save the device token for later use. The following code demonstrates the minimal code required to obtain a device token and setup event handlers:    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="comments">// Require the module</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> CloudPush = require(</code><code class="string">&apos;ti.cloudpush&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> deviceToken = </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="comments">// Initialize the module</code></div>
<div class="line"><code class="plain">CloudPush.retrieveDeviceToken({</code></div>
<div class="line"><code class="plain">    success: deviceTokenSuccess,</code></div>
<div class="line"><code class="plain">    error: deviceTokenError</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="comments">// Enable push notifications for this device</code></div>
<div class="line"><code class="comments">// Save the device token for subsequent API calls</code></div>
<div class="line"><code class="keyword">function</code><code class="plain"> deviceTokenSuccess(e) {</code></div>
<div class="line"><code class="plain">    deviceToken = e.deviceToken;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="keyword">function</code><code class="plain"> deviceTokenError(e) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&apos;Failed to register for push notifications! &apos;</code><code class="plain"> + e.error);</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain"> </code></div>
<div class="line"><code class="comments">// Process incoming push notifications</code></div>
<div class="line"><code class="plain">CloudPush.addEventListener(</code><code class="string">&apos;callback&apos;</code><code class="plain">, </code><code class="keyword">function</code><code class="plain"> (evt) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&quot;Notification received: &quot;</code><code class="plain"> + evt.payload);</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
    </div>
    </div>
    <div class="section section-3 " id="src-37551717_Subscribingtopushnotifications-ObtainingadevicetokenoniOS">
        <h3 class="heading "><span>Obtaining a device token on iOS</span></h3>
    <p>To obtain a device token on iOS, call the<tt class=" "> Titanium.Network.registerForPushNotifications()</tt>and setup callbacks for the <tt class=" ">success</tt>, <tt class=" ">error</tt>, and <tt class=" ">callback</tt> events. You can also specify the types of notifications enabled for your application, which can include one or more of the following:  <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Titanium.Network-property-NOTIFICATION_TYPE_ALERT">NOTIFICATION_TYPE_ALERT</a>, <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Titanium.Network-property-NOTIFICATION_TYPE_BADGE">NOTIFICATION_TYPE_BADGE</a>, <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Titanium.Network-property-NOTIFICATION_TYPE_NEWSSTAND">NOTIFICATION_TYPE_NEWSSTAND</a> , or  <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Titanium.Network-property-NOTIFICATION_TYPE_SOUND">NOTIFICATION_TYPE_SOUND</a>.    </p>
    <p>You need to register the user notification types you want to use with the <tt class=" ">Titanium.App.iOS.registerUserNotificationSettings()</tt>method before calling the <tt class=" ">registerForPushNotifications()</tt> method.    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="keyword">var</code><code class="plain"> deviceToken = </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="comments">// Wait for user settings to be registered before registering for push notifications</code></div>
<div class="line"><code class="plain">Ti.App.iOS.addEventListener(</code><code class="string">&apos;usernotificationsettings&apos;</code><code class="plain">, </code><code class="keyword">function</code><code class="plain"> registerForPush() {</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="plain">    </code><code class="comments">// Remove event listener once registered for push notifications</code></div>
<div class="line"><code class="plain">    Ti.App.iOS.removeEventListener(</code><code class="string">&apos;usernotificationsettings&apos;</code><code class="plain">, registerForPush);&#xA0;</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="plain">    Ti.Network.registerForPushNotifications({</code></div>
<div class="line"><code class="plain">        success: deviceTokenSuccess,</code></div>
<div class="line"><code class="plain">        error: deviceTokenError,</code></div>
<div class="line"><code class="plain">        callback: receivePush</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="comments">// Register notification types to use</code></div>
<div class="line"><code class="plain">Ti.App.iOS.registerUserNotificationSettings({</code></div>
<div class="line"><code class="plain">    types: [</code></div>
<div class="line"><code class="plain">        Ti.App.iOS.USER_NOTIFICATION_TYPE_ALERT,</code></div>
<div class="line"><code class="plain">        Ti.App.iOS.USER_NOTIFICATION_TYPE_SOUND,</code></div>
<div class="line"><code class="plain">        Ti.App.iOS.USER_NOTIFICATION_TYPE_BADGE</code></div>
<div class="line"><code class="plain">    ]</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="comments">// Process incoming push notifications</code></div>
<div class="line"><code class="keyword">function</code><code class="plain"> receivePush(e) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&apos;Received push: &apos;</code><code class="plain"> + JSON.stringify(e));</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="comments">// Save the device token for subsequent API calls</code></div>
<div class="line"><code class="keyword">function</code><code class="plain"> deviceTokenSuccess(e) {</code></div>
<div class="line"><code class="plain">    deviceToken = e.deviceToken;</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">function</code><code class="plain"> deviceTokenError(e) {</code></div>
<div class="line"><code class="plain">    alert(</code><code class="string">&apos;Failed to register for push notifications! &apos;</code><code class="plain"> + e.error);</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    </div>
    </div>
    <div class="section section-2 " id="src-37551717_Subscribingtopushnotifications-UsingtheTitaniumPushNotificationsAPI">
        <h2 class="heading "><span>Using the Titanium PushNotifications API</span></h2>
    <p>Once your application has <a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-Obtainingadevicetoken">obtained a device token</a> and setup <tt class=" ">callback</tt> event handlers, you can use the <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Modules.Cloud.PushNotifications">Modules.Cloud.PushNotifications</a> APIs to manage the user&apos;s notification subscriptions. You use the PushNotifications API to subscribe and unsubscribe to notifications <i class=" ">channels</i>, send notifications to other MBS users or devices, or query MBS for the current user&apos;s subscriptions.    </p>
    <div class="section section-3 " id="src-37551717_Subscribingtopushnotifications-Session-andtoken-basedsubscriptions">
        <h3 class="heading "><span>Session- and token-based subscriptions</span></h3>
    <p>Arrpw Push provides two ways for an application to manage its push notification subscriptions: <strong class=" ">session-based</strong> and <strong class=" ">token-based. </strong> Session-based subscriptions require that the current user be <a class="external-link external-link" href="http://docs.appcelerator.com/arrowdb/latest/#!/api/Users-method-login">logged in</a> to MBS to subscribe/unsubscribe, send, or receive push notifications. Token-based notifications only require the application to retrieve a device token (see <a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-Obtainingadevicetoken">Obtaining a device token</a> ).    </p>
    <p>The <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Modules.Cloud.PushNotifications-method-subscribe">Cloud.PushNotifications</a>  API provides equivalent methods for using either of these approaches. For instance, you call the  <tt class=" ">subscribe()</tt>method to subscribe the currently logged in API Builder Push user to a channel, or <tt class=" ">subscribeToken() </tt>to subscribe an application user with only the obtained token. Similarly, there are equivalent methods for unsubscribing from a channel <tt class=" ">(unsubscribe()</tt> and <tt class=" ">unsubscribeToken()</tt>) and sending notifications <tt class=" ">(notify() </tt>and <tt class=" ">notifyToken()</tt>).    </p>
    <div class="confbox admonition admonition-note aui-message warning shadowed information-macro">
            <p>It&apos;s recommended that you use either session- or token-based subscriptions in your application, but not both together.    </p>
    </div>
        </div>
    <div class="section section-3 " id="src-37551717_Subscribingtopushnotifications-AddingtheCloudmoduletoyourproject">
        <h3 class="heading "><span>Adding the Cloud module to your project</span></h3>
    <p>The Cloud module is included with the Titanium SDK, but is not enabled by default in new projects.    </p>
    <p><strong class=" ">To add the Cloud module to your project</strong>:    </p>
<ol class=" "><li class=" ">    <p>Open your project&apos;s <tt class=" ">tiapp.xml</tt> file.    </p>
</li><li class=" ">    <p>In the <strong class=" ">Modules</strong> section, click the Add button (green plus sign).    </p>
</li><li class=" ">    <p>Select <strong class=" ">ti.cloud</strong> and click <strong class=" ">OK</strong> <strong class=" ">.</strong>    </p>
</li></ol>    </div>
    <div class="section section-3 " id="src-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">
        <h3 class="heading "><span>Subscribing to Push Notifications with Device Tokens</span></h3>
    <p>To subscribe your application to receive push notifications using only a device the token, you call the <tt class=" ">subscribeToken()</tt>method. In the following sample code,  the user is subscribed to the &quot;news_alerts&quot; channel when tap the Subscribe button; tapping the Unsubscribe button calls the  <tt class=" ">unsubscribeToken()</tt>method.    </p>
    <p>The following example is  functionally  identical to the <a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions">token-based version</a>, except that it includes functionality to log the user into MBS.    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="comments">// You first need to get a device token (see previous section):</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> deviceToken = </code><code class="keyword">null</code><code class="plain">;</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="comments">// Require the Cloud module</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> Cloud = require(</code><code class="string">&quot;ti.cloud&quot;</code><code class="plain">);</code></div>
<div class="line"><code class="keyword">function</code><code class="plain"> subscribeToChannel () {</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Subscribes the device to the &apos;news_alerts&apos; channel</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Specify the push type as either &apos;android&apos; for Android or &apos;ios&apos; for iOS</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.subscribeToken({</code></div>
<div class="line"><code class="plain">        device_token: deviceToken,</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;news_alerts&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        type: Ti.Platform.name === </code><code class="string">&apos;android&apos;</code><code class="plain"> ? </code><code class="string">&apos;android&apos;</code><code class="plain"> : </code><code class="string">&apos;ios&apos;</code></div>
<div class="line"><code class="plain">    }, </code><code class="keyword">function</code><code class="plain"> (e) {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Subscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">function</code><code class="plain"> unsubscribeToChannel () {</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Unsubscribes the device from the &apos;test&apos; channel</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.unsubscribeToken({</code></div>
<div class="line"><code class="plain">        device_token: deviceToken,</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;news_alerts&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    }, </code><code class="keyword">function</code><code class="plain"> (e) {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Unsubscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> win = Ti.UI.createWindow({</code></div>
<div class="line"><code class="plain">    backgroundColor: </code><code class="string">&apos;white&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    layout: </code><code class="string">&apos;vertical&apos;</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">var</code><code class="plain"> subscribe = Ti.UI.createButton({ title: </code><code class="string">&apos;Subscribe&apos;</code><code class="plain"> });</code></div>
<div class="line"><code class="plain">subscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, subscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(subscribe);</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">var</code><code class="plain"> unsubscribe = Ti.UI.createButton({ title: </code><code class="string">&apos;Unsubscribe&apos;</code><code class="plain"> });</code></div>
<div class="line"><code class="plain">unsubscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, unsubscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(unsubscribe);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">win.open();</code></div>
</div>
    </div>
    </div>
    <div class="section section-3 " id="src-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithUserSessions">
        <h3 class="heading "><span>Subscribing to Push Notifications with User Sessions</span></h3>
    <p>You can subscribe to receive push notifications based the user&apos;s current MBS session. If you do not require push notifications to be sent to specific users, then consider using <a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">token-based notifications</a> .  You can create an MBS user in Appcelerator Dashboard or programmatically (as shown in the <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Modules.Cloud.Users">example</a> for  <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Modules.Cloud.Users">Modules.Cloud.Users</a> ).    </p>
    <p>The following example is identical to the <a class="document-link " href="Subscribing_to_push_notifications.html#src-37551717_Subscribingtopushnotifications-SubscribingtoPushNotificationswithDeviceTokens">token-based version</a>, except that it includes functionality to log the user into API Builder.    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="comments">// For this example to work, you need to get the device token. See the previous section.</code></div>
<div class="line"><code class="comments">// You also need an ArrowDB user account.</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="comments">// Require in the Cloud module</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> Cloud = require(</code><code class="string">&quot;ti.cloud&quot;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="keyword">function</code><code class="plain"> loginUser(){</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Log in to Arrow</code></div>
<div class="line"><code class="plain">    Cloud.Users.login({</code></div>
<div class="line"><code class="plain">        login: </code><code class="string">&apos;waldo&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        password: </code><code class="string">&apos;password&apos;</code></div>
<div class="line"><code class="plain">    }, </code><code class="keyword">function</code><code class="plain"> (e) {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Login successful&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">function</code><code class="plain"> subscribeToChannel(){</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Subscribe the user and device to the &apos;test&apos; channel</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Specify the push type as either &apos;android&apos; for Android or &apos;ios&apos; for iOS</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Check if logged in:</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.subscribe({</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;test&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        device_token: deviceToken,</code></div>
<div class="line"><code class="plain">        type: Ti.Platform.name === </code><code class="string">&apos;android&apos;</code><code class="plain"> ? </code><code class="string">&apos;android&apos;</code><code class="plain"> : </code><code class="string">&apos;ios&apos;</code></div>
<div class="line"><code class="plain">    }, </code><code class="keyword">function</code><code class="plain"> (e) {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Subscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> +</code></div>
<div class="line"><code class="plain">                ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">function</code><code class="plain"> unsubscribeToChannel ()</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Unsubscribes the user and device from the &apos;test&apos; channel</code></div>
<div class="line"><code class="plain">    Cloud.PushNotifications.unsubscribe({</code></div>
<div class="line"><code class="plain">        channel: </code><code class="string">&apos;test&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        device_token: deviceToken</code></div>
<div class="line"><code class="plain">    }, </code><code class="keyword">function</code><code class="plain"> (e) {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Unsubscribed&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">        } </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">            alert(</code><code class="string">&apos;Error:\n&apos;</code><code class="plain"> + ((e.error &amp;&amp; e.message) || JSON.stringify(e)));</code></div>
<div class="line"><code class="plain">        }</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">}</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> win = Ti.UI.createWindow({</code></div>
<div class="line"><code class="plain">    backgroundColor: </code><code class="string">&apos;white&apos;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    layout: </code><code class="string">&apos;vertical&apos;</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">var</code><code class="plain"> subscribe = Ti.UI.createButton({ title: </code><code class="string">&apos;Subscribe&apos;</code><code class="plain"> });</code></div>
<div class="line"><code class="plain">subscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, subscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(subscribe);</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="keyword">var</code><code class="plain"> unsubscribe = Ti.UI.createButton({ title: </code><code class="string">&apos;Unsubscribe&apos;</code><code class="plain"> });</code></div>
<div class="line"><code class="plain">unsubscribe.addEventListener(</code><code class="string">&apos;click&apos;</code><code class="plain">, unsubscribeToChannel);</code></div>
<div class="line"><code class="plain">win.add(unsubscribe);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="plain">win.open();</code></div>
<div class="line"><code class="plain">loginUser();</code></div>
</div>
    </div>
    </div>
    <div class="section section-3 " id="src-37551717_Subscribingtopushnotifications-UpdatingSubscriptionswithDeviceLocation">
        <h3 class="heading "><span>Updating Subscriptions with Device Location</span></h3>
    <p>AMPLIFY Appcelerator Services users can send push notifications to devices located within a geographic area you specify (see <a class="document-link " href="Sending_and_Scheduling_Push_Notifications.html">Sending and Scheduling Push Notifications</a>). For a geo-based push to reach its intended recipients, the application must periodically update its location with API Builder by calling the <tt class=" ">updateSubscription()</tt>method.    </p>
    <p>To obtain the device&apos;s current location, you call the  <tt class=" ">getCurrentPosition()</tt>or registering to listen for<tt class=" "> location</tt> events. Doing this frequently, however, can be a significant drain on the device&apos;s battery.    </p>
    <p>The <a class="external-link external-link" href="http://docs.appcelerator.com/platform/latest/#!/api/Modules.Geofence">Ti.Geofence</a> module (<strong class=" ">requires a Team or Enterprise subscription</strong>) provides a more battery-efficient way to monitor a device&apos;s movement in to, or out of, virtual geographic perimeters, or <i class=" ">geofences</i> .    </p>
    <p>When the device enters a defined geofence region, the application is notified and can obtain the device&apos;s current location and send it to API Builder. The following code demonstrates this approach.    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="keyword">var</code><code class="plain"> Cloud = require(</code><code class="string">&apos;ti.cloud&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> Geofence = require(</code><code class="string">&apos;ti.geofence&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="comments">// Define a region to monitor:</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> region1 = Geofence.createRegion({</code></div>
<div class="line"><code class="plain">    center: {</code></div>
<div class="line"><code class="plain">        latitude: 37.389601,</code></div>
<div class="line"><code class="plain">        longitude: -122.050169</code></div>
<div class="line"><code class="plain">    },</code></div>
<div class="line"><code class="plain">    radius: 500,</code></div>
<div class="line"><code class="plain">    identifier: </code><code class="string">&apos;Appcelerator&apos;</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line">&#xA0;</div>
<div class="line"><code class="comments">// Start monitoring for region entrances/exits:&#xA0;</code></div>
<div class="line"><code class="plain">Geofence.startMonitoringForRegions(region1);</code></div>
<div class="line"><code class="plain">&#xA0;</code></div>
<div class="line"><code class="comments">// Event listener invoked when device enters a region being monitored: </code></div>
<div class="line"><code class="plain">Geofence.addEventListener(</code><code class="string">&quot;enterregions&quot;</code><code class="plain">, </code><code class="keyword">function</code><code class="plain">(e) {</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// Get current location and update subscription with location:</code></div>
<div class="line"><code class="plain">    Titanium.Geolocation.getCurrentPosition(</code><code class="keyword">function</code><code class="plain">(e) {</code></div>
<div class="line"><code class="plain">    	</code><code class="keyword">if</code><code class="plain"> (e.error) {</code></div>
<div class="line"><code class="plain">    		Ti.API.error(</code><code class="string">&apos;Error: &apos;</code><code class="plain"> + e.error);</code></div>
<div class="line"><code class="plain">    	} </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">    		</code><code class="keyword">var</code><code class="plain"> latitude = e.coords.latitude;</code></div>
<div class="line"><code class="plain">    		</code><code class="keyword">var</code><code class="plain"> longitude = e.coords.longitude;</code></div>
<div class="line"><code class="plain">    		Cloud.PushNotifications.updateSubscription({</code></div>
<div class="line"><code class="plain">    			device_token : pushDeviceToken,</code></div>
<div class="line"><code class="plain">    			loc : [longitude, latitude]</code></div>
<div class="line"><code class="plain">    		}, </code><code class="keyword">function</code><code class="plain">(e) {</code></div>
<div class="line"><code class="plain">    			</code><code class="keyword">if</code><code class="plain"> (e.success) {</code></div>
<div class="line"><code class="plain">    				alert(</code><code class="string">&apos;Subscription Updated.&apos;</code><code class="plain">);</code></div>
<div class="line"><code class="plain">    			} </code><code class="keyword">else</code><code class="plain"> {</code></div>
<div class="line"><code class="plain">    				alert(e);</code></div>
<div class="line"><code class="plain">    			}</code></div>
<div class="line"><code class="plain">    		});</code></div>
<div class="line"><code class="plain">    	}</code></div>
<div class="line"><code class="plain">    });</code></div>
<div class="line"><code class="plain">});</code></div>
</div>
    </div>
    </div>
    </div>
    <div class="section section-2 " id="src-37551717_Subscribingtopushnotifications-Parsinganotificationpayload">
        <h2 class="heading "><span>Parsing a notification payload</span></h2>
    <p>The notification payload that is delivered to the device is modified slightly structure is a bit different between Android and iOS, as shown below.    </p>
    <p>The original JSON payload:    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;title&quot;</code><code class="plain">: </code><code class="string">&quot;Example&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;alert&quot;</code><code class="plain">: </code><code class="string">&quot;Sample alert&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;icon&quot;</code><code class="plain">: </code><code class="string">&quot;little_star&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;badge&quot;</code><code class="plain">: 3,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;sound&quot;</code><code class="plain">: </code><code class="string">&quot;door_bell&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;vibrate&quot;</code><code class="plain">: </code><code class="keyword">true</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;custom_field_1&quot;</code><code class="plain">: </code><code class="string">&quot;Appcelerator ArrowDB Rocks!&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;custom_field_2&quot;</code><code class="plain">: </code><code class="string">&quot;Hi Push&quot;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <p>iOS payload:    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;aps&quot;</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;alert&quot;</code><code class="plain">: </code><code class="string">&quot;Sample alert&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;badge&quot;</code><code class="plain">: 3,</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;sound&quot;</code><code class="plain">: </code><code class="string">&quot;door_bell&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    },</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;title&quot;</code><code class="plain">: </code><code class="string">&quot;Example&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;icon&quot;</code><code class="plain">: </code><code class="string">&quot;little_star&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;vibrate&quot;</code><code class="plain">: </code><code class="keyword">true</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;custom_field_1&quot;</code><code class="plain">: </code><code class="string">&quot;Appcelerator ArrowDB Rocks!&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;custom_field_2&quot;</code><code class="plain">: </code><code class="string">&quot;Hi Push&quot;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <p>Android parsed payload:    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;android&quot;</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;title&quot;</code><code class="plain">: </code><code class="string">&quot;Example&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;alert&quot;</code><code class="plain">: </code><code class="string">&quot;Sample alert&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;icon&quot;</code><code class="plain">: </code><code class="string">&quot;little_star&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;badge&quot;</code><code class="plain">: 3,</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;sound&quot;</code><code class="plain">: </code><code class="string">&quot;door_bell&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">        </code><code class="string">&quot;vibrate&quot;</code><code class="plain">: </code><code class="keyword">true</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    },</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;custom_field_1&quot;</code><code class="plain">: </code><code class="string">&quot;Appcelerator ArrowDB Rocks!&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">    </code><code class="string">&quot;custom_field_2&quot;</code><code class="plain">: </code><code class="string">&quot;Hi Push&quot;</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <p>For example, in the following example the <tt class=" ">receivePush()</tt> method was previously assigned to the notification callback handler. The following code parses the alert string from the notification payload, and assigns it to a variable named <tt class=" ">alertString</tt>.    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="keyword">var</code><code class="plain"> ostype = Titanium.Platform.osname;</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> alertString;</code></div>
<div class="line"><code class="keyword">function</code><code class="plain"> receivePush(e) {</code></div>
<div class="line"><code class="plain">	</code><code class="keyword">if</code><code class="plain">(ostype === </code><code class="string">&quot;android&quot;</code><code class="plain">){</code></div>
<div class="line"><code class="plain">    	alertString = JSON.parse(e.payload).android.alert;</code></div>
<div class="line"><code class="plain">	}</code></div>
<div class="line"><code class="plain">	</code><code class="keyword">if</code><code class="plain">(ostype === </code><code class="string">&quot;iphone&quot;</code><code class="plain"> || ostype === </code><code class="string">&quot;ipad&quot;</code><code class="plain">){</code></div>
<div class="line"><code class="plain">    	alertString = e.data.aps.alert;</code></div>
<div class="line"><code class="plain">	}</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <p>Sample payload sent push notification in the multiline format on an Android device:    </p>
    <div class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">   </code><code class="string">&quot;title&quot;</code><code class="plain">: </code><code class="string">&quot;myApp&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">   </code><code class="string">&quot;alert&quot;</code><code class="plain">: </code><code class="string">&quot;Here, I want to send the multiline push notification messages to the user for the \n details reports.&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">   </code><code class="string">&quot;style&quot;</code><code class="plain">: {</code></div>
<div class="line"><code class="plain">      </code><code class="string">&quot;bigContentTitle&quot;</code><code class="plain">: </code><code class="string">&quot;myApp&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">      </code><code class="string">&quot;bigText&quot;</code><code class="plain">: </code><code class="string">&quot;Here, I want to send the multiline push notification messages to the user for the \n details reports.&quot;</code><code class="plain">,</code></div>
<div class="line"><code class="plain">      </code><code class="string">&quot;summaryText&quot;</code><code class="plain">: </code><code class="string">&quot;Here, I want to send the multiline push notification messages&quot;</code></div>
<div class="line"><code class="plain">   }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    </div>
    <div class="section section-2 " id="src-37551717_Subscribingtopushnotifications-Moreexamples">
        <h2 class="heading "><span>More examples</span></h2>
    <p>For another demonstration of the PushNotification API, run the Cloud demo app and select <strong class=" ">Push Notifications</strong>. The code for the Cloud demo is located in the Cloud module at<tt class=" "> &lt;PATH_TO_TITANIUM_SDK&gt;/modules/commonjs/ti.cloud/&lt;VERSION&gt;/example/</tt>.    </p>
    </div>
    <div class="section section-2 " id="src-37551717_Subscribingtopushnotifications-Troubleshooting">
        <h2 class="heading "><span>Troubleshooting</span></h2>
    <div class="section section-3 " id="src-37551717_safe-id-U3Vic2NyaWJpbmd0b3B1c2hub3RpZmljYXRpb25zLVVuYWJsZXRvcmV0cmlldmVhZGV2aWNldG9rZW4oaU9TKQ">
        <h3 class="heading "><span>Unable to retrieve a device token (iOS)</span></h3>
    </div>
    <div class="section section-3 " id="src-37551717_safe-id-U3Vic2NyaWJpbmd0b3B1c2hub3RpZmljYXRpb25zLUVycm9yOkFQU0Nsb3VkUHVzaGhhc25vdGJlZW5lbmFibGVkLkNhbGxBUFNDbG91ZC5lbmFibGUoY29udGV4dCxrZXkpdG9lbmFibGUuKEFuZHJvaWQp">
        <h3 class="heading "><span>Error: APSCloudPush has not been enabled. Call APSCloud.enable(context, key) to enable. (Android)</span></h3>
    <p>If LiveView is enabed, disable it.  There are some known conflict when using LiveView and push notification services (<a class="external-link external-link" href="https://jira.appcelerator.org/browse/TISTUD-7116">TISTUD-7116</a> and <a class="external-link external-link" href="https://jira.appcelerator.org/browse/TISTUD-7487">TISTUD-7487</a>).    </p>
    </div>
    </div>
        </div>
    
        
    </div>
</body>
</html>
