<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Windows Background Service Quick Start</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta content="Scroll EclipseHelp Exporter" name="generator"/>

    <link type="text/css" rel="stylesheet" href="css/eclipse-defaults.css" />
    <link type="text/css" rel="stylesheet" href="css/common.css" />
    <link type="text/css" rel="stylesheet" href="css/print.css" media="print" />
</head>
<body>
    <div class="container">
        <div class="header"></div>

        <div id="src-46248264" class="content">
                        <h1>Windows Background Service Quick Start</h1>
    <p  >    </p>
<ul class="toc-indentation "><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-Introduction">Introduction</a>    </p>
</li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-WindowsModulePrerequisites">Windows Module Prerequisites</a>    </p>
</li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-CreateaNewModule">Create a New Module</a>    </p>
</li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-BuildandPackagetheModule">Build and Package the Module</a>    </p>
</li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-TesttheModule">Test the Module</a>    </p>
<ul class="toc-indentation "><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-CreateaTestApplication">Create a Test Application</a>    </p>
</li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-AddtheModuleasaDependencytotheProject">Add the Module as a Dependency to the Project</a>    </p>
</li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-LoadtheModuleandMakeModuleAPICalls">Load the Module and Make Module API Calls</a>    </p>
</li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-RuntheApplication">Run the Application</a>    </p>
</li></ul></li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-ModifytheModule">Modify the Module</a>    </p>
<ul class="toc-indentation "><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-ImplementBackgroundTask">Implement Background Task</a>    </p>
</li></ul></li><li class=" ">    <p  ><a  class="document-link " href="Windows_Background_Service_Quick_Start.html#src-46248264_WindowsBackgroundServiceQuickStart-NextSteps">Next Steps</a>    </p>
</li></ul>    <div class="section section-2 " id="src-46248264_WindowsBackgroundServiceQuickStart-Introduction">
        <h2 class="heading "><span>Introduction</span></h2>
    <p  >This guide walks through the steps to create, build and test an Windows background service module using Studio. The equivalent CLI instructions are given in the information boxes near the top of each section. <strong class=" ">This feature is available as of Titanium SDK 6.0.0.GA.</strong>    </p>
    </div>
    <div class="section section-2 " id="src-46248264_WindowsBackgroundServiceQuickStart-WindowsModulePrerequisites">
        <h2 class="heading "><span>Windows Module Prerequisites</span></h2>
    <p  >To develop an Windows-based Module, you'll need all of the software required to build a Titanium application for Windows:    </p>
<ul class=" "><li class=" ">    <p  >Titanium SDK    </p>
</li><li class=" ">    <p  >Supported versions of Visual Studio and the Windows Phone SDK, as described in <a  class="document-link " href="Installing_the_Windows_Phone_SDK.html">Installing the Windows Phone SDK</a>    </p>
</li><li class=" ">    <p  >Studio or the Appcelerator Command-Line Interface (CLI) for creating modules, and building and running test applications    </p>
</li></ul>    <p  >Like Windows application development, Windows module development is only supported on Windows.    </p>
    </div>
    <div class="section section-2 " id="src-46248264_WindowsBackgroundServiceQuickStart-CreateaNewModule">
        <h2 class="heading "><span>Create a New Module</span></h2>
    <p  >First, create a new module project.    </p>
    <div  class="confbox admonition admonition-info aui-message hint shadowed information-macro">
            <div class="title">CLI Instructions</div>
            <p  >From a terminal, change the current working directory to your workspace and run:    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">cd /PATH/TO/WORKSPACE</code></div>
<div class="line"><code class="plain">appc </code><code class="keyword">new</code><code class="plain"> -n test --id com.example.test</code></div>
<div class="line"><code class="plain">### when prompted </code><code class="keyword">for</code><code class="plain"> the project type, select </code><code class="string">"Titanium Module"</code><code class="plain"> </code></div>
</div>
    </div>
    </div>
        <p  >In Studio:    </p>
<ol class=" "><li class=" ">    <p  >From the menu, select <strong class=" ">File</strong> &gt; <strong class=" ">New</strong> &gt; <strong class=" ">Mobile Module Project</strong> to open the <strong class=" ">New Mobile Module Project</strong> dialog.    </p>
</li><li class=" ">    <p  >In the <strong class=" ">Project name</strong> field, enter <strong class=" ">test</strong>.    </p>
</li><li class=" ">    <p  >In the <strong class=" ">Module Id</strong> field, enter <strong class=" ">com.example.test</strong>.    </p>
</li><li class=" ">    <p  >In <strong class=" ">Deployment Targets</strong>, select <strong class=" ">Windows</strong>.    </p>
</li><li class=" ">    <p  >Click <strong class=" ">Next</strong>, then click <strong class=" ">Finish</strong>.    </p>
</li></ol>    <p  >Studio sets up a new folder called <tt class=" ">test</tt> that contains your module project.    </p>
    </div>
    <div class="section section-2 " id="src-46248264_WindowsBackgroundServiceQuickStart-BuildandPackagetheModule">
        <h2 class="heading "><span>Build and Package the Module</span></h2>
    <p  >Next, build the module and package it.  This process produces a ZIP file containing a binary library with unprocessed module assets, example code and documentation.    </p>
    <div  class="confbox admonition admonition-info aui-message hint shadowed information-macro">
            <div class="title">CLI Instructions</div>
            <p  >From a terminal, go to the module's windows directory and run the <tt class=" ">appc ti build -p windows --build-only</tt>    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">cd test/windows</code></div>
<div class="line"><code class="plain">appc ti build -p windows --build-only</code></div>
</div>
    </div>
    <p  >After the build completes, unzip the built module in the Titanium SDK home path: (<tt class=" ">C:\ProgramData\Titanium</tt>).    </p>
    </div>
        <p  >In Studio:    </p>
<ol class=" "><li class=" ">    <p  >Select your module folder in the <strong class=" ">Project Explorer</strong> view.    </p>
</li><li class=" ">    <p  >Verify <strong class=" ">Package</strong> and <strong class=" ">Windows Module</strong> are displayed in <strong class=" ">Launch Mode</strong> and <strong class=" ">Launch Target</strong>, respectively.    </p>
</li><li class=" ">    <p  >Click the Package icon to open the <strong class=" ">Package Windows Module</strong> dialog.    </p>
</li><li class=" ">    <p  >In <strong class=" ">Output Location</strong>, choose the <strong class=" ">Titanium SDK</strong> to install the module in the Titanium SDK home path to be accessed by any Titanium application.    </p>
</li><li class=" ">    <p  >Click <strong class=" ">Finish</strong>.    </p>
</li></ol>    <p  >Studio builds and installs the module to the Titanium SDK home path.    </p>
    </div>
    <div class="section section-2 " id="src-46248264_WindowsBackgroundServiceQuickStart-TesttheModule">
        <h2 class="heading "><span>Test the Module</span></h2>
    <p  >To test the module, create a test application and add the module as a dependency of the project.  Then, load the module and make module API calls to the module reference.    </p>
    <div class="section section-3 " id="src-46248264_WindowsBackgroundServiceQuickStart-CreateaTestApplication">
        <h3 class="heading "><span>Create a Test Application</span></h3>
    <p  >    </p>
    <div  class="confbox admonition admonition-info aui-message hint shadowed information-macro">
            <div class="title">CLI Instructions</div>
            <p  >From a new terminal window, change the current working directory to your workspace and run the following commands:    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">cd /PATH/TO/WORKSPACE</code></div>
<div class="line"><code class="plain">appc </code><code class="keyword">new</code><code class="plain"> -t titanium -p windows -n Hello -u http:</code><code class="comments">// --id com.example.hello</code></div>
<div class="line"><code class="plain">cd Hello/</code></div>
</div>
    </div>
    </div>
        <p  >In Studio:    </p>
<ol class=" "><li class=" ">    <p  >From the menu, select <strong class=" ">File</strong> &gt; <strong class=" ">New</strong> &gt; <strong class=" ">Mobile App Project</strong> to open the <strong class=" ">New Mobile App Project</strong> dialog.    </p>
</li><li class=" ">    <p  >On the <strong class=" ">Project Template</strong> page, select <strong class=" ">Default Alloy Project</strong> as the template type, then click <strong class=" ">Next</strong>.    </p>
</li><li class=" ">    <p  >On the <strong class=" ">Project Location</strong> page, enter the following information:    </p>
<ul class=" "><li class=" ">    <p  >In the <strong class=" ">Project Name</strong> field, enter <strong class=" ">Hello</strong>.    </p>
</li><li class=" ">    <p  >In the <strong class=" ">App ID</strong> field, enter <strong class=" ">com.example.hello</strong>.    </p>
</li><li class=" ">    <p  >In <strong class=" ">Deployment Targets</strong>, select <strong class=" ">Windows</strong>.    </p>
</li></ul></li><li class=" ">    <p  >Click <strong class=" ">Finish</strong> to create the project.    </p>
</li></ol>    <p  >Studio sets up a new folder called <tt class=" ">Hello</tt> that contains the test application you will be using to test the module.    </p>
    </div>
    <div class="section section-3 " id="src-46248264_WindowsBackgroundServiceQuickStart-AddtheModuleasaDependencytotheProject">
        <h3 class="heading "><span>Add the Module as a Dependency to the Project</span></h3>
    <p  >To load the module in the application, you need to add it as a dependency to the project.    </p>
    <div  class="confbox admonition admonition-info aui-message hint shadowed information-macro">
            <div class="title">CLI Instructions</div>
            <p  >Open the <tt class=" ">tiapp.xml</tt> and update the <tt class=" ">&lt;modules/&gt;</tt> element to include the module as a dependency to the project. In addition to that Windows background module requires <tt class=" ">Extension</tt> element with <tt class=" ">EntryPoint</tt> specified. In <tt class=" ">EntryPoint</tt> you need to specify a background service class name, which is named &quot;camel-cased module identifier&quot; plus &quot;<tt class=" ">BackgroundServiceTask</tt>&quot;. In this example since we uses &quot;com.example.test&quot; as an module id, background task entry point goes to &quot;<tt class=" ">ComExampleTest.BackgroundServiceTask</tt>&quot;.    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">&lt;ti:app&gt;</code></div>
<div class="line"><code class="plain">  &lt;modules&gt;</code></div>
<div class="line"><code class="plain">    &lt;module platform=</code><code class="string">"windows"</code><code class="plain">&gt;com.example.test&lt;/module&gt;</code></div>
<div class="line"><code class="plain">  &lt;/modules&gt;</code></div>
<div class="line"><code class="plain">  &lt;windows&gt;</code></div>
<div class="line"><code class="plain">    &lt;manifest&gt;</code></div>
<div class="line"><code class="plain">      &lt;Extensions&gt;</code></div>
<div class="line"><code class="plain">        &lt;Extension Category=</code><code class="string">"windows.backgroundTasks"</code><code class="plain"> EntryPoint=</code><code class="string">"ComExampleTest.BackgroundServiceTask"</code><code class="plain">&gt;</code></div>
<div class="line"><code class="plain">          &lt;BackgroundTasks&gt;</code></div>
<div class="line"><code class="plain">            &lt;Task Type=</code><code class="string">"timer"</code><code class="plain"> /&gt;</code></div>
<div class="line"><code class="plain">          &lt;/BackgroundTasks&gt;</code></div>
<div class="line"><code class="plain">        &lt;/Extension&gt;</code></div>
<div class="line"><code class="plain">      &lt;/Extensions&gt;</code></div>
<div class="line"><code class="plain">    &lt;/manifest&gt;</code></div>
<div class="line"><code class="plain">  &lt;/windows&gt;</code></div>
<div class="line"><code class="plain">&lt;/ti:app&gt;</code></div>
</div>
    </div>
    </div>
        </div>
    <div class="section section-3 " id="src-46248264_WindowsBackgroundServiceQuickStart-LoadtheModuleandMakeModuleAPICalls">
        <h3 class="heading "><span>Load the Module and Make Module API Calls</span></h3>
    <p  >Open the <tt class=" ">app.js</tt> file and replace the code with the following, which invokes background service API calls to the module. In this example we use <tt class=" ">registerTimerTask</tt> to register <a class="external-link external-link" href="https://msdn.microsoft.com/en-us/library/windows/apps/windows.applicationmodel.background.timetrigger.aspx">Windows::ApplicationModel::Background::TimeTrigger</a> which is invoked for each 15 minutes interval.    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                    <div class="title">app.js</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="app.js">
<div class="line"><code class="plain">var win = Ti.UI.createWindow();</code></div>
<div class="line"><code class="plain">var task;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">win.addEventListener(</code><code class="string">'open'</code><code class="plain">, function() {</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="comments">// Clear all tasks that is associated with this app</code></div>
<div class="line"><code class="plain">  Ti.App.Windows.BackgroundService.unregisterAllTasks();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="comments">// Register new task that is invoked for each 15 minutes interval.</code></div>
<div class="line"><code class="plain">  task = Ti.App.Windows.BackgroundService.registerTimerTask(</code><code class="string">'ComExampleTest.BackgroundServiceTask'</code><code class="plain">, </code><code class="value">15</code><code class="plain">, </code><code class="keyword">false</code><code class="plain">);</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="keyword">if</code><code class="plain"> (task) {</code></div>
<div class="line"><code class="plain">    Ti.API.info(</code><code class="string">"Background task is registered: task id="</code><code class="plain"> + task.taskId);</code></div>
<div class="line"><code class="plain">  }</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">win.open();</code></div>
</div>
    </div>
    </div>
    <div class="section section-3 " id="src-46248264_WindowsBackgroundServiceQuickStart-RuntheApplication">
        <h3 class="heading "><span>Run the Application</span></h3>
    <p  >    </p>
    <div  class="confbox admonition admonition-info aui-message hint shadowed information-macro">
            <div class="title">CLI Instructions</div>
            <p  >From a terminal that has the test app as its current working directory, run:    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code">
<div class="line"><code class="plain">appc run -p windows</code></div>
</div>
    </div>
    </div>
        <p  >In the Studio toolbar, select <strong class=" ">Run</strong> in <strong class=" ">Launch Modes</strong> and select an Windows Phone simulator in <strong class=" ">Launch Targets</strong>.    </p>
    <p  >Studio builds and launches the application on the select Windows Phone simulator.  Monitor the <strong class=" ">Console</strong> view for log output.    </p>
    <p  >The console lines seen below show us that the module is working as expected.    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                    <div class="title">Console</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="Console">
<div class="line"><code class="plain">[INFO]  Background task is registered: task </code><code class="functions">id</code><code class="plain">=0</code></div>
</div>
    </div>
    </div>
    </div>
    <div class="section section-2 " id="src-46248264_WindowsBackgroundServiceQuickStart-ModifytheModule">
        <h2 class="heading "><span>Modify the Module</span></h2>
    <p  >Let's modify the module code to create a view object and access a string property.    </p>
    <p  >First, look at some of the default files created by the Titanium SDK.  Expand the <tt class=" ">windows</tt> folder.  Inside this folder are two files:    </p>
<ul class=" "><li class=" ">    <p  ><tt class=" ">src/ComExampleTest.cpp</tt>: This is a boiler plate Module class. Every module requires a module class, which acts as the base API for the module.    </p>
</li><li class=" ">    <p  >i<tt class=" ">nclude/ComExampleTest.hpp</tt>: This is a header file for the boiler plate class.    </p>
</li></ul>    <div class="section section-3 " id="src-46248264_WindowsBackgroundServiceQuickStart-ImplementBackgroundTask">
        <h3 class="heading "><span>Implement Background Task</span></h3>
    <p  >In <tt class=" ">ComExampleTestModule.cpp</tt> file you'll find <tt class=" ">BackgroundServiceTask</tt> class inside namespace <tt class=" ">ComExampleTest</tt>.    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                    <div class="title">ComExampleTest.cpp</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="ComExampleTest.cpp">
<div class="line"><code class="keyword">namespace</code><code class="plain"> ComExampleTest</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="comments">/*</code></div>
<div class="line"><code class="comments">     * @class</code></div>
<div class="line"><code class="comments">     * @discussion This is background task for BackgroundService.</code></div>
<div class="line"><code class="comments">     *             EntryPoint: ComExampleTest.BackgroundServiceTask</code></div>
<div class="line"><code class="comments">     *</code></div>
<div class="line"><code class="comments">     *   Usage: (JavaScript)</code></div>
<div class="line"><code class="comments">     *     var task = Ti.App.Windows.BackgroundService.registerTimerTask(</code></div>
<div class="line"><code class="comments">     *                          'ComExampleTest.BackgroundServiceTask', 15, false);</code></div>
<div class="line"><code class="comments">     *</code></div>
<div class="line"><code class="comments">     *   Don't remove this class because Windows Store submission process requires</code></div>
<div class="line"><code class="comments">     *   at least one C++/CX class in winmd. (TIMOB-20192)</code></div>
<div class="line"><code class="comments">     * </code></div>
<div class="line"><code class="comments">     */</code></div>
<div class="line"><code class="plain">    [Windows::Foundation::Metadata::WebHostHidden]</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain"> ref </code><code class="keyword">class</code><code class="plain"> BackgroundServiceTask sealed : </code><code class="keyword">public</code><code class="plain"> Windows::ApplicationModel::Background::IBackgroundTask</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">public</code><code class="plain">:</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">virtual</code><code class="plain"> </code><code class="keyword">void</code><code class="plain"> Run(Windows::ApplicationModel::Background::IBackgroundTaskInstance^ taskInstance);</code></div>
<div class="line"><code class="plain">    };</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">/*</code></div>
<div class="line"><code class="comments">     * BackgroundServiceTask::Run implementation</code></div>
<div class="line"><code class="comments">     */</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">void</code><code class="plain"> BackgroundServiceTask::Run(IBackgroundTaskInstance^ taskInstance)</code></div>
<div class="line"><code class="plain">    {</code></div>
<div class="line"><code class="plain">        </code><code class="keyword">const</code><code class="plain"> auto deferral = taskInstance-&gt;GetDeferral();</code></div>
<div class="line"><code class="plain">        </code><code class="comments">//</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// BACKGROUND TASK: IMPLEMENT SOMETHING USEFUL HERE :)</code></div>
<div class="line"><code class="plain">        </code><code class="comments">//</code></div>
<div class="line"><code class="plain">        </code><code class="comments">// Inform this task has finished</code></div>
<div class="line"><code class="plain">        deferral-&gt;Complete();</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <p  >BackgroundServiceTask implements Windows Background Service <a class="external-link external-link" href="https://msdn.microsoft.com/library/windows/apps/br224794"><tt class=" ">IBackgroundTask</tt></a> interface so you can implement a task that works in the background. The implementation for background task should be inside <tt class=" ">BackgroundServiceTask::Run</tt> function:    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                    <div class="title">ComExampleTest.cpp</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="ComExampleTest.cpp">
<div class="line"><code class="comments">/*</code></div>
<div class="line"><code class="comments"> * BackgroundServiceTask::Run implementation</code></div>
<div class="line"><code class="comments"> */</code></div>
<div class="line"><code class="keyword">void</code><code class="plain"> BackgroundServiceTask::Run(IBackgroundTaskInstance^ taskInstance)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">const</code><code class="plain"> auto deferral = taskInstance-&gt;GetDeferral();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">//</code></div>
<div class="line"><code class="plain">    </code><code class="comments">// BACKGROUND TASK: IMPLEMENT SOMETHING USEFUL HERE :)</code></div>
<div class="line"><code class="plain">    </code><code class="comments">//</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// Inform this task has finished</code></div>
<div class="line"><code class="plain">    deferral-&gt;Complete();</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <p  >Let's implement something useful here: let say we want a number to count how many times background task is executed. Important thing you need to know here is that <tt class=" ">BackgroundServiceTask</tt> doesn't have a state because background task is executed and finished on each invocation. So you need a way to save a state: in this case we can use <tt class=" ">ApplicationData::Current-&gt;LocalSettings</tt> or local file storage to store values. In this example let's use <tt class=" ">LocalSettings</tt> for now:    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                    <div class="title">ComExampleTest.cpp</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="ComExampleTest.cpp">
<div class="line"><code class="keyword">using</code><code class="plain"> </code><code class="keyword">namespace</code><code class="plain"> Windows::Foundation;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> </code><code class="keyword">namespace</code><code class="plain"> Windows::ApplicationModel::Background;</code></div>
<div class="line"><code class="keyword">using</code><code class="plain"> </code><code class="keyword">namespace</code><code class="plain"> Windows::Storage;</code></div>
<div class="line"> </div>
<div class="line"><code class="comments">/*</code></div>
<div class="line"><code class="comments"> * BackgroundServiceTask::Run implementation</code></div>
<div class="line"><code class="comments"> */</code></div>
<div class="line"><code class="keyword">void</code><code class="plain"> BackgroundServiceTask::Run(IBackgroundTaskInstance^ taskInstance)</code></div>
<div class="line"><code class="plain">{</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">const</code><code class="plain"> auto deferral = taskInstance-&gt;GetDeferral();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="color1">int</code><code class="plain"> count = 0;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">const</code><code class="plain"> auto settings = ApplicationData::Current-&gt;LocalSettings;</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">const</code><code class="plain"> auto values = settings-&gt;Values;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// In this example we use "ComExampleTest.BackgroundServiceTask.count" key to store count value</code></div>
<div class="line"><code class="plain">    Platform::String^ key = </code><code class="string">"ComExampleTest.BackgroundServiceTask.count"</code><code class="plain">;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// Restore count from settings...</code></div>
<div class="line"><code class="plain">    </code><code class="keyword">if</code><code class="plain"> (values-&gt;HasKey(key)) {</code></div>
<div class="line"><code class="plain">       count = safe_cast&lt;IPropertyValue^&gt;(values-&gt;Lookup(key))-&gt;GetInt32();</code></div>
<div class="line"><code class="plain">    }</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// Let's count up</code></div>
<div class="line"><code class="plain">    count++;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// Save the count so that BackgroundServiceTask can lookup.</code></div>
<div class="line"><code class="plain">    settings-&gt;Values-&gt;Insert(</code><code class="string">"ComExampleTest.BackgroundServiceTask.count"</code><code class="plain">, </code><code class="keyword">dynamic_cast</code><code class="plain">&lt;PropertyValue^&gt;(PropertyValue::CreateInt32(count)));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">    </code><code class="comments">// Inform this task has finished</code></div>
<div class="line"><code class="plain">    deferral-&gt;Complete();</code></div>
<div class="line"><code class="plain">}</code></div>
</div>
    </div>
    <p  >In this example we saves count value to <tt class=" ">&quot;ComExampleTest.BackgroundServiceTask.count&quot;</tt> local setting. Good new is that you can actually get the value from JavaScript using <tt class=" ">Ti.App.Properties</tt> with same key &quot;<tt class=" ">ComExampleTest.BackgroundServiceTask.count</tt>&quot;. Because we save the state in the local settings, count value is still saved even when app is finished or even all background tasks are unregistered.    </p>
    <div  class="confbox programlisting defaultnew syntaxhighlighter scroll-html-formatted-code">
                    <div class="title">app.js</div>
                <div xmlns="http://www.w3.org/1999/xhtml" class="defaultnew syntaxhighlighter scroll-html-formatted-code" data-title="app.js">
<div class="line"><code class="keyword">var</code><code class="plain"> win = Ti.UI.createWindow();</code></div>
<div class="line"><code class="keyword">var</code><code class="plain"> task;</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">win.addEventListener(</code><code class="string">'open'</code><code class="plain">, </code><code class="keyword">function</code><code class="plain">() {</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="comments">// Let's print out task execution count</code></div>
<div class="line"><code class="plain">  Ti.API.info(</code><code class="string">'Task execution count: '</code><code class="plain"> + Ti.App.Properties.getInt(</code><code class="string">'ComExampleTest.BackgroundServiceTask.count'</code><code class="plain">));</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="comments">// Clear all tasks that is associated with this app</code></div>
<div class="line"><code class="plain">  Ti.App.Windows.BackgroundService.unregisterAllTasks();</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">  </code><code class="comments">// Register new task that is invoked for each 15 minutes interval.</code></div>
<div class="line"><code class="plain">  task = Ti.App.Windows.BackgroundService.registerTimerTask(</code><code class="string">'ComExampleTest.BackgroundServiceTask'</code><code class="plain">, 15, </code><code class="keyword">false</code><code class="plain">);</code></div>
<div class="line"><code class="plain">  </code><code class="keyword">if</code><code class="plain"> (task) {</code></div>
<div class="line"><code class="plain">    Ti.API.info(</code><code class="string">'Background task is registered: task id='</code><code class="plain"> + task.taskId);</code></div>
<div class="line"><code class="plain">  }</code></div>
<div class="line"><code class="plain">});</code></div>
<div class="line"> </div>
<div class="line"><code class="plain">win.open();</code></div>
</div>
    </div>
    </div>
    </div>
    <div class="section section-2 " id="src-46248264_WindowsBackgroundServiceQuickStart-NextSteps">
        <h2 class="heading "><span>Next Steps</span></h2>
<ul class=" "><li class=" ">    <p  >For information about Windows Runtime Background Service API, see <a class="external-link external-link" href="https://msdn.microsoft.com/en-us/library/windows/apps/windows.applicationmodel.background.aspx">Windows.ApplicationModel.Background namespace</a>    </p>
</li><li class=" ">    <p  >For a general overview of background tasks in Windows Store apps, see the <a class="external-link external-link" href="https://www.microsoft.com/download/en/details.aspx?id=27411">Introduction to Background Tasks</a> whitepaper    </p>
</li><li class=" ">    <p  >For example code that shows how to implement background tasks, see the <a class="external-link external-link" href="http://code.msdn.microsoft.com/windowsapps/background-task-sample-9209ade9">Background Task Sample</a>.    </p>
</li></ul>    <p  >    </p>
    </div>
        </div>
    
        <div class="footer">
            Created with <a href="http://k15t.com/display/web/Scroll-Wiki-EclipseHelp-Exporter-for-Confluence">Scroll EclipseHelp Exporter for Confluence</a>.
        </div>
    </div>
</body>
</html>
